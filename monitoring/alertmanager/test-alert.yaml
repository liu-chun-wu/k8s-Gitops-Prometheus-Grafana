apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: test-discord-alert
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    prometheus: kube-prometheus-stack-prometheus
spec:
  groups:
  - name: test.alerts
    interval: 30s
    rules:
    
    # æ¸¬è©¦ç”¨è­¦å ± - æœƒç«‹å³è§¸ç™¼
    - alert: TestDiscordNotification
      expr: vector(1) > 0
      for: 1m
      labels:
        severity: info
        service: test
      annotations:
        summary: "ğŸ§ª Discord é€šçŸ¥æ¸¬è©¦"
        description: "é€™æ˜¯ä¸€å€‹æ¸¬è©¦è­¦å ±ï¼Œç”¨æ–¼é©—è­‰ Discord é€šçŸ¥æ˜¯å¦æ­£å¸¸é‹ä½œã€‚å¦‚æœæ‚¨åœ¨ Discord æ”¶åˆ°æ­¤è¨Šæ¯ï¼Œè¡¨ç¤ºè­¦å ±ç³»çµ±é…ç½®æˆåŠŸï¼"
        
    # æ¸¬è©¦ Warning ç´šåˆ¥
    - alert: TestWarningAlert
      expr: vector(1) > 0.5
      for: 2m
      labels:
        severity: warning
        service: test
      annotations:
        summary: "âš ï¸ æ¸¬è©¦ Warning è­¦å ±"
        description: "é€™æ˜¯ä¸€å€‹ Warning ç´šåˆ¥çš„æ¸¬è©¦è­¦å ±"
        
    # æ¸¬è©¦ Critical ç´šåˆ¥ï¼ˆé è¨­é—œé–‰ï¼‰
    - alert: TestCriticalAlert
      expr: vector(1) > 2  # ä¸æœƒè§¸ç™¼ï¼Œå› ç‚º vector(1) æ°¸é ç­‰æ–¼ 1
      for: 1m
      labels:
        severity: critical
        service: test
      annotations:
        summary: "ğŸš¨ æ¸¬è©¦ Critical è­¦å ±"
        description: "é€™æ˜¯ä¸€å€‹ Critical ç´šåˆ¥çš„æ¸¬è©¦è­¦å ±"
        
---
# æ‰‹å‹•è§¸ç™¼æ¸¬è©¦çš„ ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-test-instructions
  namespace: monitoring
data:
  instructions.md: |
    # æ¸¬è©¦è­¦å ±ç³»çµ±
    
    ## 1. è¨­å®š Discord Webhook
    
    é¦–å…ˆï¼Œéœ€è¦åœ¨ Discord å»ºç«‹ Webhookï¼š
    1. åœ¨ Discord ä¼ºæœå™¨ä¸­ï¼Œé€²å…¥é »é“è¨­å®š
    2. é¸æ“‡ã€Œæ•´åˆã€â†’ã€ŒWebhookã€
    3. å»ºç«‹æ–°çš„ Webhook ä¸¦è¤‡è£½ URL
    
    ## 2. æ›´æ–° Secret
    
    ```bash
    # ç·¨è¼¯ Secretï¼Œæ›¿æ› YOUR_DISCORD_WEBHOOK_URL
    kubectl edit secret alertmanager-discord-webhook -n monitoring
    
    # æˆ–ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç›´æ¥æ›´æ–°
    kubectl create secret generic alertmanager-discord-webhook \
      --from-literal=webhook-url='YOUR_ACTUAL_DISCORD_WEBHOOK_URL' \
      --namespace=monitoring \
      --dry-run=client -o yaml | kubectl apply -f -
    ```
    
    ## 3. éƒ¨ç½²è­¦å ±é…ç½®
    
    ```bash
    # éƒ¨ç½² Discord è½‰ç™¼æœå‹™
    kubectl apply -f monitoring/alertmanager/alertmanager-discord-secret.yaml
    
    # éƒ¨ç½²è­¦å ±è¦å‰‡
    kubectl apply -f monitoring/alertmanager/prometheus-rules.yaml
    
    # éƒ¨ç½²æ¸¬è©¦è­¦å ±
    kubectl apply -f monitoring/alertmanager/test-alert.yaml
    ```
    
    ## 4. é©—è­‰è­¦å ±
    
    ```bash
    # æª¢æŸ¥è­¦å ±è¦å‰‡æ˜¯å¦è¼‰å…¥
    kubectl get prometheusrule -n monitoring
    
    # æª¢æŸ¥ AlertManager ç‹€æ…‹
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-alertmanager 9093:9093
    # é–‹å•Ÿç€è¦½å™¨è¨ªå• http://localhost:9093
    
    # æª¢æŸ¥ Prometheus è­¦å ±ç‹€æ…‹
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
    # é–‹å•Ÿç€è¦½å™¨è¨ªå• http://localhost:9090/alerts
    ```
    
    ## 5. æ‰‹å‹•è§¸ç™¼æ¸¬è©¦
    
    å¦‚æœè¦ç«‹å³è§¸ç™¼ Critical è­¦å ±æ¸¬è©¦ï¼Œå¯ä»¥æš«æ™‚ä¿®æ”¹è¦å‰‡ï¼š
    
    ```bash
    kubectl edit prometheusrule test-discord-alert -n monitoring
    # å°‡ TestCriticalAlert çš„ expr æ”¹ç‚º: vector(1) > 0
    ```
    
    ## 6. æ¸…ç†æ¸¬è©¦è­¦å ±
    
    æ¸¬è©¦å®Œæˆå¾Œï¼Œåˆªé™¤æ¸¬è©¦è­¦å ±ï¼š
    
    ```bash
    kubectl delete prometheusrule test-discord-alert -n monitoring
    ```