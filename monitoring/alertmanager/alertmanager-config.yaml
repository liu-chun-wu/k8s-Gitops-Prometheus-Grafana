apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-kube-prometheus-stack-alertmanager
  namespace: monitoring
  labels:
    app: kube-prometheus-stack-alertmanager
    app.kubernetes.io/instance: kube-prometheus-stack
    app.kubernetes.io/managed-by: Helm
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 1m
      
    # å®šç¾©é€šçŸ¥æ¨¡æ¿
    templates:
    - '/etc/alertmanager/config/*.tmpl'
    
    # æ¥æ”¶å™¨é…ç½®
    receivers:
    # é è¨­æ¥æ”¶å™¨ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
    - name: 'null'
    
    # Discord æ¥æ”¶å™¨
    - name: 'discord-critical'
      webhook_configs:
      - url: 'http://alertmanager-discord:9094'
        send_resolved: true
        http_config:
          tls_config:
            insecure_skip_verify: true
        title: 'ğŸš¨ ç·Šæ€¥è­¦å ±'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        
    - name: 'discord-warning'
      webhook_configs:
      - url: 'http://alertmanager-discord:9094'
        send_resolved: true
        http_config:
          tls_config:
            insecure_skip_verify: true
        title: 'âš ï¸ è­¦å‘Šé€šçŸ¥'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        
    - name: 'discord-info'
      webhook_configs:
      - url: 'http://alertmanager-discord:9094'
        send_resolved: true
        http_config:
          tls_config:
            insecure_skip_verify: true
        title: 'â„¹ï¸ è³‡è¨Šé€šçŸ¥'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
    
    # è·¯ç”±é…ç½®
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 5s
      group_interval: 15s
      repeat_interval: 1m
      receiver: 'null'
      
      routes:
      # Watchdog è­¦å ±ï¼ˆå¥åº·æª¢æŸ¥ï¼‰éœéŸ³
      - match:
          alertname: Watchdog
        receiver: 'null'
        continue: false
        
      # ä¾åš´é‡æ€§åˆ†é…ä¸åŒæ¥æ”¶å™¨
      - match:
          severity: critical
        receiver: 'discord-critical'
        group_wait: 5s
        repeat_interval: 1m
        
      - match:
          severity: warning
        receiver: 'discord-warning'
        group_wait: 5s
        repeat_interval: 1m
        
      - match:
          severity: info
        receiver: 'discord-info'
        group_wait: 5s
        repeat_interval: 1m
        
      # æ‡‰ç”¨ç¨‹å¼ç‰¹å®šè·¯ç”±
      - match_re:
          service: podinfo.*
        receiver: 'discord-warning'
        group_by: ['alertname', 'pod']
        group_wait: 5s
        repeat_interval: 1m
    
    # æŠ‘åˆ¶è¦å‰‡ï¼ˆé¿å…é‡è¤‡è­¦å ±ï¼‰
    inhibit_rules:
    # Critical è­¦å ±æŠ‘åˆ¶ warning å’Œ info
    - source_match:
        severity: 'critical'
      target_match_re:
        severity: 'warning|info'
      equal: ['alertname', 'namespace']
      
    # Warning è­¦å ±æŠ‘åˆ¶ info
    - source_match:
        severity: 'warning'
      target_match:
        severity: 'info'
      equal: ['alertname', 'namespace']
      
    # åŒ namespace çš„ InfoInhibitor æŠ‘åˆ¶æ‰€æœ‰ info è­¦å ±
    - source_match:
        alertname: 'InfoInhibitor'
      target_match:
        severity: 'info'
      equal: ['namespace']